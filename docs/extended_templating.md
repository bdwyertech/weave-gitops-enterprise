# Extended templating

In order to better support templating the following additions have been introduced

- File path templating
- Filter functions

Both of these additions could be classed as missing functionality to the original
weave enterprise UI.

## File path templating

In Weave Enterprise, paths are statically defined with the exception of the
cluster and namespace which were autogenerated into a file path but immutable.

To better extend the capabilities of path and file management, additional
templating parameters can now be defined and these will be injected into the
template as during generation.

For example, under the original weaveworks implementation, the following two
paths were immutable:

- `capi.repositoryPath`
- `capi.repositoryClustersPath`

Under the changes introduced here, these can now accept template options using
the golang template `{{ .VAR_NAME }}` syntax.

```yaml
config:
  capi:
    repositoryPath: "management-clusters/{{ .MANAGEMENT_CLUSTER }}/organizations/{{ .organization }}/workload-clusters/{{ .CLUSTER_NAME }}"
    repositoryClustersPath: mapi/clusters
```

By default, the following additional parameters are always available for use in
templates:

- `MANAGEMENT_CLUSTER`
- `REPOSITORY_PATH`
- `REPOSITORY_CLUSTERS_PATH`
- `BASE_BRANCH`

In addition to the above, additional fields may also be provided by setting the
`config.capi.extraReplacementFields` property.

```yaml
config:
  capi:
    extraReplacementFields:
      constantValue: some constant string
      lookedUpValue: namespace:{{ .NAMESPACE }}:giantswarm.io/organization
```

> **Note** The specifier for if a value is looked up or not is that it is a
> colon (`:`) separated string. You should avoid using colons in your replacements

In order for a value to be looked up, it must be a valid resource type inside
your cluster.

The full format for the string is: `type:[namespace/]name:field[:label-or-annotation]`

Type **must** be fully qualified as `kind.group/version`. For example, to look up
all `Deployments` you would use `deployment.apps/v1` as the `type` specifier. If
you find the lookup is not returning any results, check for plurality and use
the singular for `kind`.

## Filtering

When defining lists of items to use inside your template it is often the case
you want to present options to the end user whereby elements are referencing
real resources inside the cluster.

Under the original weaveworks EE edition, this was not possible and instead it
was expected that the lookup would be done seperately and the value entered
manually to the template.

> **Warning** This performs real lookups to the API which will add additional
> load on to the api server or may not return all responses if the permissions
> granted to the user are insufficient to present all options.

This option is only available for option types and cannot be used for other
fields.

In order to use the filtering function, the first and only element in the
`parameter.options` field must be a string matching the pattern below.

If this is not the case, the option will be returned as a static defined option.

```nohighlight
{{ kind[.group[/version]] options=value... }}
```

Available options for the filter are:

- `filterPrefix` only include results whose `metadata.name` is prefixed with `prefix`
- `filterSuffix` only include results whose `metadata.name` ends with `suffix`
- `matchLabels` only include results whose labels match the specifier
- `namespace` only include results from the given namespace

Of these, `filterPrefix`, `filterSuffix` and `namespace` accept a single string
value which may optionally be quoted. For example `filterPrefix=dev-`

`matchLabels` is a little more complicated as it accepts pipe (`|`) seperated
list of `key=value` pairs or [set based selectors].

When a label selector is specified, key=value pairs may optionally be quoted whilst
set based selectors must always be quoted.

For example:

```yaml
spec:
  - description: Will be deployed to this namespace
    name: NAMESPACE
    options:
      - '{{ namespace filterPrefix:"dev-" }}'
  - description: This template will be used with the following manager
    name: MANAGERS
    options:
      - '{{ deployment.apps/v1 matchLabels="app.kubernetes.io/component in (manager)"|environment=dev filterSuffix=-controller }}'
```

> **Note** Irrespective of the order defined, set based selectors always have
> precedence over key value pairs.

If you need to test if your expression will work correctly, you can use this
filter to test: [https://regex101.com/r/EZCKDe/1](https://regex101.com/r/EZCKDe/1)git mer

[set based selectors]: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#set-based-requirement
